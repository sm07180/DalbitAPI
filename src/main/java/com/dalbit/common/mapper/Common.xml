<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.common.dao.CommonDao" >
    <select id="callBroadCastRoomStreamIdRequest" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_broadcast_room_streamid_request(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callCodeDefineSelect" resultType="Map">
      	call sp_code_define_select
    </select>

    <insert id="requestSms" parameterType="SmsVo" useGeneratedKeys="true" keyProperty="CMID" keyColumn="CMID">
        <selectKey keyProperty="CMID" resultType="int" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
      	INSERT INTO hp_msg(
          UMID
          , MSG_TYPE
          , SEND_PHONE
          , DEST_PHONE
          , SUBJECT
          , MSG_BODY
          , VXML_FILE
          , mem_no
        ) values(
          #{umId}
          , '0'
          , #{sendPhoneNo}
          , #{phoneNo}
          , 'TEST'
          , CONCAT('[',#{text},'] 인증번호는 (', #{code}, ') 입니다.')
          , #{authType}
          , #{memNo}
        )
    </insert>

    <select id="callMemberCertification" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_member_certification(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="getCertificationChk" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_member_certification_check(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="saveErrorLog" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_log_error_data(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callPushAdd" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_stmp_push_add(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="selectItemList" parameterType="P_ItemVo" resultType="ItemVo">
        /* Common.xml - selectItemList */
        SELECT
                item_code         AS itemNo
                , item_name         AS itemNm
                , (CASE
                    WHEN use_area = '1' THEN IF(item_slct = 2, 'particle', 'ani')
                    WHEN use_area = '2' THEN 'sticker'
                    ELSE 'ani'
                END) AS `type`
                , item_price        AS cost
                , item_thumbnail    AS thumbs
                , webp_image        AS webpUrl
                , jason_image       AS lottieUrl
                , (CASE
                    WHEN use_area in ('1', '4') THEN 360
                    WHEN use_area = '2' THEN 108
                    WHEN use_area = '3' THEN 720
                    WHEN use_area = '5' THEN 720
                END) AS width
                , (CASE
                    WHEN use_area in ('1', '4') THEN 900
                    WHEN use_area = '2' THEN 108
                    WHEN use_area = '3' THEN 504
                    WHEN use_area = '5' THEN 1080
                END) AS height
                , (CASE
                    WHEN use_area in ('1', '4') THEN 0.5
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 1
                    WHEN use_area = '5' THEN 1
                END) AS deviceRate
                , (CASE
                    WHEN use_area in ('1', '4') THEN 1
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 1
                    WHEN use_area = '5' THEN 1
                END) AS widthRate
                , (CASE
                    WHEN use_area in ('1', '4') THEN 2.5
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 0.7
                    WHEN use_area = '5' THEN 1.5
                END) AS heightRate
                , (CASE
                    WHEN use_area = '2' THEN 'midLeft'
                    WHEN use_area = '3' THEN 'topLeft'
                    WHEN use_area = '5' THEN 'topLeft'
                    ELSE 'bottomRight'
                END) AS location
                , play_time         AS duration
                , (CASE
                    WHEN use_area = '2' THEN 'combo'
                    WHEN use_area = '1' THEN 'emotion'
                    ELSE 'normal'
                END)AS category
                , (CAST(SUBSTR(item_type, 1, 1) AS INT) = 1) AS isNew
                , @rownum := @rownum + 1 AS sortNo
        FROM rd_data.tbl_gift_item a, (SELECT @rownum := 0 ) AS f
        WHERE view_yn = 1
            AND item_code NOT IN ('U1447', 'U1885')
            AND item_slct = #{item_slct}
            AND platform like #{platform}
        ORDER BY isNew DESC, item_price ASC, item_name ASC
    </select>

    <select id="selectBooster" parameterType="String" resultType="ItemVo">
        /* Common.xml - selectBooster */
        SELECT
                item_code         AS itemNo
                , item_name         AS itemNm
                , (CASE
                    WHEN use_area = '1' THEN 'particle'
                    WHEN use_area = '2' THEN 'sticker'
                    ELSE 'ani'
                END) AS `type`
                , item_price        AS cost
                , item_thumbnail    AS thumbs
                , webp_image        AS webpUrl
                , jason_image       AS lottieUrl
                , (CASE
                    WHEN use_area in ('1', '4') THEN 360
                    WHEN use_area = '2' THEN 108
                    WHEN use_area = '3' THEN 720
                    WHEN use_area = '5' THEN 720
                END) AS width
                , (CASE
                    WHEN use_area in ('1', '4') THEN 900
                    WHEN use_area = '2' THEN 108
                    WHEN use_area = '3' THEN 504
                    WHEN use_area = '5' THEN 1080
                END) AS height
                , (CASE
                    WHEN use_area in ('1', '4') THEN 0.5
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 1
                    WHEN use_area = '5' THEN 1
                END) AS deviceRate
                , (CASE
                    WHEN use_area in ('1', '4') THEN 1
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 1
                    WHEN use_area = '5' THEN 1
                END) AS widthRate
                , (CASE
                    WHEN use_area in ('1', '4') THEN 2.5
                    WHEN use_area = '2' THEN 1
                    WHEN use_area = '3' THEN 0.7
                    WHEN use_area = '5' THEN 1.5
                END) AS heightRate
                , (CASE
                    WHEN use_area = '2' THEN 'midLeft'
                    WHEN use_area = '3' THEN 'topLeft'
                    WHEN use_area = '5' THEN 'topLeft'
                    ELSE 'bottomRight'
                END) AS location
                , play_time         AS duration
                , (CASE
                    WHEN use_area = '2' THEN 'combo'
                    WHEN use_area = '1' THEN 'emotion'
                    ELSE 'normal'
                END)AS category
                , (CAST(SUBSTR(item_type, 1, 1) AS INT) = 1) AS isNew
                , 1 AS sortNo
        FROM rd_data.tbl_gift_item
        WHERE item_code = #{value}
    </select>

    <select id="selectItem" parameterType="String" resultType="ItemDetailVo">
        /* Common.xml - selectItem */
        SELECT
                item_code         AS itemNo
                , item_name         AS itemNm
                , item_price        AS cost
                , item_thumbnail    AS thumbs
                , webp_image        AS webpUrl
                , jason_image       AS lottieUrl
                , byeol
        FROM rd_data.tbl_gift_item
        WHERE view_yn = 1
          AND item_code = #{value}
    </select>

    <select id="selectAppVersion" parameterType="Integer" resultType="AppVersionVo">
        /* Common.xml - selectAppVersion */
        SELECT
            version
            , build_no AS buildNo
            , upBuild_no AS upBuildNo
        FROM rd_admin.tb_app_version
        WHERE os = #{value}
            AND is_use = 1
        ORDER BY IDX DESC
        LIMIT 0, 1
    </select>

    <select id="banWordSelect" parameterType="String" resultType="BanWordVo">
        /* Common.xml - banWordSelect */
        SELECT
            ban_word AS banWord
        FROM tbl_banword
        WHERE is_use = 1
        ORDER BY idx DESC
        limit 0, 1
    </select>

    <select id="broadcastBanWordSelect" parameterType="BanWordVo" resultType="BanWordVo">
        /* Common.xml - broadcastBanWordSelect */
        SELECT
            ban_word AS banWord
        FROM tb_member_broadcast_banword
        WHERE 1=1
        <choose>
            <when test='memNo != null and memNo != ""'>
                AND mem_no = #{memNo}
            </when>
            <when test='roomNo != null and roomNo != ""'>
                AND mem_no = (select mem_no from tb_broadcast_room where room_no = #{roomNo})
            </when>
            <otherwise>
                AND mem_no = '99999999999999'
            </otherwise>
        </choose>
    </select>

    <select id="selectNowBroadcast" parameterType="String" resultType="NowBroadcastVo">
        SELECT
            @isInforex := IFNULL((SELECT `inner` FROM tb_member_basic WHERE mem_no = #{value}), 0) AS isInforex
            , IF(@isInforex = 1, (SELECT COUNT(*) FROM tb_broadcast_room WHERE state &lt; 4), 0) AS roomCnt
            , IF(@isInforex = 1, (SELECT COUNT(*) FROM tb_broadcast_room a INNER JOIN tb_broadcast_room_member b ON a.room_no = b.room_no AND a.state &lt; 4 AND b.auth &lt; 3 AND b.state = 0), 0) AS listenerCnt
    </select>

    <select id="selectCodeDefine" parameterType="com.dalbit.common.vo.CodeVo" resultType="com.dalbit.common.vo.CodeVo">
        /* Common.xml - selectCodeDefine */
        SELECT `type` as cd
            , `value` as `value`
            , code    as cdNm
            , `order` as sortNo
            , is_use  as isUse
        FROM rd_data.tbl_code_define
        where `type` = #{cd}
            and code = #{cdNm}
    </select>

    <select id="callMemberBadgeSelect" statementType="CALLABLE" parameterType="java.util.HashMap" resultType="com.dalbit.common.vo.FanBadgeVo">
      call sp_member_badge_select(#{mem_no, mode=IN, jdbcType=INTEGER}, #{type, mode=IN, jdbcType=INTEGER})
    </select>
</mapper>