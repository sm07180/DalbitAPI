<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.event.dao.EventDao" >

    <select id="callEventRankingLive" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_RankingLiveOutputVo">
      call sp_event_ranking_live(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventRankingResult" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_RankingResultOutputVo">
      call sp_event_ranking_result	(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventReplyList" parameterType="com.dalbit.event.vo.procedure.P_ReplyListInputVo" resultType="com.dalbit.event.vo.procedure.P_ReplyListOutputVo">
      /* Event.xml - callEventReplyList */
      SELECT
            a.idx AS reply_idx
            ,a.event_idx AS event_idx
            ,a.mem_no AS write_mem_no
            ,a.depth AS depth
            ,a.contents AS contents
            ,a.status AS status
            ,a.reg_date AS writeDate
            ,a.op_name AS op_name
            ,a.last_upd_date AS updateDate
            ,mb.mem_userId AS userId
            ,mb.mem_nick AS nickName
            ,mb.mem_sex AS memSex
            ,#{mem_no} AS req_mem_no
            ,(SELECT image_profile FROM rd_data.tb_member_profile WHERE mem_no = a.mem_no) AS profileImage
        FROM
            rd_admin.tb_event_reply AS a
        LEFT JOIN
            rd_data.tb_member_basic AS mb
        ON
            a.mem_no = mb.mem_no
        WHERE
            a.event_idx = ${event_idx}
            AND a.depth = 1
            AND a.status = 1
        ORDER BY
            a.idx desc
    </select>

    <insert id="callEventReplyAdd" parameterType="com.dalbit.event.vo.procedure.P_ReplyAddInputVo">
        /* Event.xml - callEventReplyAdd */
        INSERT INTO rd_admin.tb_event_reply
        (
            event_idx
            ,mem_no
            ,depth
            ,contents
            ,status
            ,reg_date
            ,op_name
        )
        VALUES
        (
             #{event_idx}
             ,#{mem_no}
             ,#{depth}
             ,#{contents}
             ,1
             ,NOW()
             ,#{op_name}
        )
    </insert>

    <update id="callEventReplyDelete" parameterType="com.dalbit.event.vo.procedure.P_ReplyDeleteInputVo">
        /* Event.xml - callEventReplyDelete */
        UPDATE rd_admin.tb_event_reply
        SET
          status = 2
          ,op_name = #{mem_no}
          ,last_upd_date = NOW()
        WHERE
          idx = #{reply_idx}
          AND event_idx = #{event_idx}
    </update>

    <select id="callEventAuthCheck" parameterType="com.dalbit.event.vo.procedure.P_ReplyDeleteInputVo" resultType="integer">
        /* Event.xml - callEventAuthCheck */
        SELECT
          count(*)
        FROM
        (
             SELECT
                mem_no
             FROM
                rd_admin.tb_event_reply AS er
             WHERE
                er.event_idx = #{event_idx} AND er.idx = #{reply_idx} AND er.mem_no = #{mem_no}
             UNION ALL
             SELECT
                mem_no
             FROM
                rd_data.tb_member_basic AS mb
             WHERE
                mb.mem_no = #{mem_no} AND mb.inner = 1
          ) AS a
    </select>

    <select id="callAttendanceCheckLoad" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_AttendanceCheckLoadOutputVo">
        call sp_member_attendance_check_load(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAttendanceCheckGift" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_AttendanceCheckLoadOutputVo">
        call sp_member_attendance_check_gift(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAttendanceCheckBonus" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_AttendanceCheckLoadOutputVo">
        call sp_member_attendance_check_bonus(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callRisingLive" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_RisingEventListOutputVo">
      call sp_event_rising_live(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callRisingResult" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_RisingEventListOutputVo">
      call sp_event_rising_result(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAttendanceCheck" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_member_attendance_check(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callPhoneInput" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
      call sp_gifticon_phone_input(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callGifticonWinList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_GifticonWinListOutputVo">
      call sp_gifticon_win_list(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="selectLunarDate" resultType="com.dalbit.event.vo.LunarVo">
        /* Event.xml - selectLunarDate */
        SELECT
            concat(month (date), '월 ', day(date), '일') as lunarDate
            , date_format(date, '%Y%m%d') date
        FROM tbl_lunar_calendar
        where date_format(now(), '%y%m%d') <![CDATA[<=]]> date
        ORDER BY ABS(DATEDIFF(NOW(), DATE))
        LIMIT 1
    </select>

    <select id="selectPhotoList" parameterType="com.dalbit.event.vo.PhotoEventInputVo" resultType="com.dalbit.event.vo.PhotoEventOutputVo">
        /* Event.xml - selectPhotoList */
        select photo.idx
            , photo.event_idx
            , photo.mem_no
            , photo.image_url
            , photo.contents
            , date_format(photo.reg_date, '%Y.%m.%d %H:%i') reg_date
            , level.level
            , profile.image_profile
            , ifnull(basic.mem_nick, withdrawal.mem_nick) mem_nick
        from rd_admin.tb_event_photo photo
            inner join rd_data.tb_member_level level on photo.mem_no = level.mem_no
            inner join rd_data.tb_member_profile profile on photo.mem_no = profile.mem_no
            left join rd_data.tb_member_basic basic on photo.mem_no = basic.mem_no
            left join rd_data.tb_member_withdrawal_bak withdrawal on photo.mem_no = withdrawal.mem_no
        where photo.del_yn = 0
            and photo.event_idx = #{event_idx}
        <if test='slct_type == 1' >
            and photo.mem_no = #{mem_no}
        </if>
        order by photo.reg_date desc

        <if test='slct_type != 1' >
            limit #{page}, #{records}
        </if>
    </select>

    <select id="selectPhotoCnt" parameterType="com.dalbit.event.vo.PhotoEventInputVo" resultType="int">
        /* Event.xml - selectPhotoCnt */
        select count(*)
        from rd_admin.tb_event_photo
        where del_yn = 0
            and event_idx = #{event_idx}
        <if test='slct_type == 1' >
            and mem_no = #{mem_no}
        </if>
    </select>

    <insert id="insertEventMember" parameterType="com.dalbit.event.vo.EventMemberVo">
        /* Event.xml - insertEventMember */
        <selectKey keyProperty="event_member_idx" resultType="int" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into rd_admin.tb_event_member(
            event_idx
            , mem_no
            , platform
            , enter_date
            , reg_date
            , op_name
        )values(
            #{event_idx}
            , #{mem_no}
            , #{platform}
            , now()
            , now()
            , #{mem_no}
        )
    </insert>

    <select id="callEventApply" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call rd_data.sp_event_apply(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <update id="deleteEventMemberPhoto" parameterType="com.dalbit.event.vo.PhotoEventInputVo">
        /* Event.xml - deleteEventMember */
        update rd_admin.tb_event_member
        set
            del_yn = #{del_yn}
            , last_op_name = #{mem_no}
            , last_upd_date = now()
        where idx = (select event_member_idx from rd_admin.tb_event_photo where idx = #{idx})
    </update>

    <insert id="insertPhoto" parameterType="com.dalbit.event.vo.PhotoEventInputVo">
        /* Event.xml - insertPhoto */
        insert into rd_admin.tb_event_photo(
            event_idx
            , event_member_idx
            , mem_no
            , image_url
            , contents
            , reg_date
        )values(
            #{event_idx}
            , #{event_member_idx}
            , #{mem_no}
            , #{image_url}
            , #{contents}
            , now()
        )
    </insert>

    <update id="updatePhoto" parameterType="com.dalbit.event.vo.PhotoEventInputVo">
        /* Event.xml - updatePhoto */
        update rd_admin.tb_event_photo
        set
            image_url = #{image_url}
            , contents = #{contents}
            , op_name = #{mem_no}
            , last_upd_date = now()
        where idx = #{idx}
    </update>

    <update id="deletePhoto" parameterType="com.dalbit.event.vo.PhotoEventInputVo">
        /* Event.xml - updatePhoto */
        update rd_admin.tb_event_photo
        set
            del_yn = #{del_yn}
            , op_name = #{mem_no}
            , last_upd_date = now()
        where idx = #{idx}
    </update>

    <select id="selectPhotoPcAirTime" parameterType="com.dalbit.event.vo.PhotoEventInputVo" resultType="int">
        select ifnull(sum(airtime), 0) airtime
        from rd_data.tb_broadcast_room
        where os_type = 3
            and (select start_datetime from rd_admin.tb_event_basic where idx = #{event_idx}) <![CDATA[<=]]> start_date
            and start_date <![CDATA[<=]]> (select end_datetime from rd_admin.tb_event_basic where idx = #{event_idx})
            and mem_no = #{mem_no}
    </select>

    <select id="selectEventBasic" parameterType="int" resultType="com.dalbit.event.vo.EventBasicVo">
        /* Event.xml - selectEventBasic */
        select
            idx
            , event_title
            , start_datetime
            , end_datetime
            , view_start_datetime
            , view_end_datetime
            , platform
            , event_slct
            , is_pop
            , is_view
            , is_reply
            , pc_img_url
            , pc_link_url
            , mobile_img_url
            , mobile_link_url
            , thumb_img_url
            , `desc`
            , reg_date
            , op_name
            , last_upd_date
            , last_op_name
        from rd_admin.tb_event_basic
        where idx = #{idx}
    </select>

    <select id="selectKnowhowList" parameterType="com.dalbit.event.vo.KnowhowEventInputVo" resultType="com.dalbit.event.vo.KnowhowEventOutputVo">
        /* Event.xml - selectKnowhowList */
        select photo.idx
            , photo.event_idx
            , photo.mem_no
            , photo.image_url
            , photo.image_url2
            , photo.image_url3
            , photo.title
            , photo.contents
            , photo.view_cnt
            , photo.good_cnt
            , photo.slct_device
            , photo.device1
            , photo.device2
            , date_format(photo.reg_date, '%Y.%m.%d %H:%i') reg_date
            , level.level
            , profile.image_profile
            , ifnull(basic.mem_nick, withdrawal.mem_nick) mem_nick
            , ifnull((select count(*) from rd_admin.tb_event_good good where photo.event_idx = good.event_idx and good.mem_no = #{mem_no} and photo.idx = good.add_idx), 0) is_good
        from rd_admin.tb_event_photo photo
            inner join rd_data.tb_member_level level on photo.mem_no = level.mem_no
            inner join rd_data.tb_member_profile profile on photo.mem_no = profile.mem_no
            left join rd_data.tb_member_basic basic on photo.mem_no = basic.mem_no
            left join rd_data.tb_member_withdrawal_bak withdrawal on photo.mem_no = withdrawal.mem_no
        where photo.del_yn = 0
            and photo.event_idx = #{event_idx}
        <if test='slct_type == 1' >
            and photo.mem_no = #{mem_no}
        </if>

        <if test='slct_platform == 1' >
            and photo.slct_device in (1, 2)
        </if>
        <if test='slct_platform == 2' >
            and photo.slct_device in (3, 4, 5)
        </if>

        <choose>
            <when test='slct_order == 1'>
                order by photo.good_cnt desc, photo.reg_date desc
            </when>
            <otherwise>
                order by photo.reg_date desc
            </otherwise>
        </choose>

        <if test='slct_type != 1' >
            limit #{page}, #{records}
        </if>
    </select>

    <select id="selectKnowhowDetail" parameterType="com.dalbit.event.vo.KnowhowEventInputVo" resultType="com.dalbit.event.vo.KnowhowEventOutputVo">
        /* Event.xml - selectKnowhowDetail */
        select
            photo.idx
            , photo.event_idx
            , photo.mem_no
            , photo.image_url
            , photo.image_url2
            , photo.image_url3
            , photo.title
            , photo.contents
            , photo.slct_device
            , photo.device1
            , photo.device2
            , date_format(photo.reg_date, '%Y.%m.%d %H:%i') reg_date
            , photo.view_cnt
            , photo.good_cnt
            , level.level
            , profile.image_profile
            , ifnull(basic.mem_nick, withdrawal.mem_nick) mem_nick
            , ifnull((select count(*) from rd_admin.tb_event_good where event_idx = #{event_idx} and mem_no = #{mem_no} and add_idx = #{idx}), 0) is_good
        from rd_admin.tb_event_basic evt
            inner join rd_admin.tb_event_photo photo on evt.idx = photo.event_idx
            inner join rd_data.tb_member_level level on photo.mem_no = level.mem_no
            inner join rd_data.tb_member_profile profile on photo.mem_no = profile.mem_no
            left join rd_data.tb_member_basic basic on photo.mem_no = basic.mem_no
            left join rd_data.tb_member_withdrawal_bak withdrawal on photo.mem_no = withdrawal.mem_no
        where photo.idx = #{idx}
            and evt.idx = #{event_idx}
    </select>

    <update id="updatePhotoViewCnt" parameterType="int">
        /* Event.xml - updatePhotoViewCnt */
        UPDATE rd_admin.tb_event_photo
        SET
          view_cnt = view_cnt + 1
        WHERE
          idx = #{idx}
    </update>

    <select id="selectKnowhowCnt" parameterType="com.dalbit.event.vo.KnowhowEventInputVo" resultType="int">
        /* Event.xml - selectKnowhowCnt */
        select count(*)
        from rd_admin.tb_event_photo
        where del_yn = 0
        and event_idx = #{event_idx}
        <if test='slct_type == 1' >
            and mem_no = #{mem_no}
        </if>
        <if test='slct_platform == 1' >
            and slct_device in (1, 2)
        </if>
        <if test='slct_platform == 2' >
            and slct_device in (3, 4, 5)
        </if>
    </select>

    <insert id="insertKnowhow" parameterType="com.dalbit.event.vo.PhotoEventInputVo">
        /* Event.xml - insertKnowhow */
        insert into rd_admin.tb_event_photo(
            event_idx
            , event_member_idx
            , mem_no
            , image_url
            , image_url2
            , image_url3
            , title
            , contents
            , slct_device
            , device1
            , device2
            , reg_date
        )values(
            #{event_idx}
            , #{event_member_idx}
            , #{mem_no}
            , #{image_url}
            , #{image_url2}
            , #{image_url3}
            , #{title}
            , #{contents}
            , #{slct_device}
            , #{device1}
            , #{device2}
            , now()
        )
    </insert>

    <update id="updateKnowhow" parameterType="com.dalbit.event.vo.KnowhowEventInputVo">
        /* Event.xml - updateKnowhow */
        update rd_admin.tb_event_photo
        set image_url = #{image_url, jdbcType=VARCHAR}
            , image_url2 = #{image_url2, jdbcType=VARCHAR}
            , image_url3 = #{image_url3, jdbcType=VARCHAR}
            , title = #{title}
            , contents = #{contents}
            , slct_device = #{slct_device}
            , device1 = #{device1}
            , device2 = #{device2}
            , op_name = #{mem_no}
            , last_upd_date = now()
        where idx = #{idx}
            and mem_no = #{mem_no}
            and event_idx = #{event_idx}
    </update>

    <select id="callEventGood" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_good(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventApplyCheck" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_apply_check(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventApplyCheck004" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_apply_check_004(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventApplySP" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_apply(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventApply003" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_apply_003(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventDetail003" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_detail_003(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventApply004" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_apply_004(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_EventPageListOutputVo">
        call sp_event_page(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageWinList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_EventPageWinListOutputVo">
        call sp_event_page_win_list(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageWinResult" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_EventPageWinResultOutputVo">
        call sp_event_page_win_result(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPagePrizeReceiveWay" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_page_prize_receive_way(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageWinnerAddInfoSelect" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_page_winner_add_info_select(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageWinnerAddInfoEdit" statementType="CALLABLE" parameterType="ProcedureVo" resultType="ProcedureVo">
        call sp_event_page_winner_add_info_edit(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callEventPageWinnerInfoFormat" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.event.vo.procedure.P_EventPageWinnerInfoFormatVo">
        call sp_event_page_winner_info_format(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="selectTimeEventInfo" parameterType="com.dalbit.event.vo.TimeEventVo" resultType="com.dalbit.event.vo.TimeEventVo">
        /* Event.xml - selectTimeEventInfo */
        select
            date_format(start_date, '%Y.%m.%d %H:%i:%s') as start_date
            , date_format(end_date, '%Y.%m.%d %H:%i:%s') as end_date
            , event_time as minute
            , rate
        from rd_data.tbl_time_event
        where `state` = 0
            and start_date <![CDATA[<=]]> now()
            and now() <![CDATA[<=]]> end_date
        limit 1
    </select>
</mapper>