<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.main.dao.MainDao" >

    <select id="callMainFanRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainFanRankingVo">
        call sp_ranking_fan(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainDjRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainDjRankingVo">
        call sp_ranking_dj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainMyDjList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainMyDjVo">
        call sp_broadcast_room_list_mydj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainRecommandList" parameterType="P_MainRecommandVo" resultType="P_MainRecommandVo">
        SELECT
        *
        FROM (
            SELECT
                T1.mem_no AS memNo
                , (select mem_nick from tb_member_basic where mem_no = T1.mem_no ) AS nickNm
                , (select mem_sex from tb_member_basic where mem_no = T1.mem_no ) AS gender
                , (select image_profile from tb_member_profile where mem_no = T1.mem_no ) AS profileUrl
                , T1.room_no AS roomNo
                , T1.subject_type AS roomType
                , T1.title AS title
                , IFNULL(T1.count_entry, 0) AS listeners
                , IFNULL(T1.count_good, 0) AS likes
                , T1.image_background AS bannerUrl
            FROM (
                SELECT
                    a.room_no
                    , a.mem_no
                    , a.title
                    , a.image_background
                    , a.subject_type
                    , (count_good + fn_get_point_used_item(a.room_no, 'U1447')) AS count_good
                    , count_entry
                    , (select ifnull(sum(ifnull(gold, 0)), 0) from tb_member_broadcast_item where room_no = a.room_no and item_type = 1) as count_gold
                FROM tb_broadcast_room a
                WHERE a.state &lt; 4
                ORDER BY ((count_good*0.5)+(count_entry*0.3)+(count_gold*0.2)) desc
                LIMIT 0, 10
            ) T1

            UNION ALL

            SELECT
                idx AS memNo
                , 'banner' AS nickNm
                , '' AS gender
                , thumb_img_url AS profileUrl
                , IF(#{paramDevice} = '3', pc_link_url, mobile_link_url) AS roomNo
                , IF(is_pop = 1, 'popup', 'link') AS roomType
                , title AS title
                , 0 AS listeners
                , 0 AS likes
                , IF(#{paramDevice} = '3', pc_img_url, mobile_img_url) AS bannerUrl
            FROM rd_admin.tb_admin_banner
            WHERE is_view = 1
                AND (
                  platform = 0
                  OR
                  platform = (CASE
                    WHEN #{paramDevice} = '3' THEN 1
                    ELSE 2
                  END)
                )
                AND position = 1
                AND (
                  view_type = 0
                  OR
                  (
                    (view_type = 1  AND (
                      sex = 0 OR sex = (
                            SELECT
                              (CASE
                                WHEN mem_sex = 'm' THEN 1
                                WHEN mem_sex = 'f' THEN 2
                                ELSE 3
                              END)
                            FROM tb_member_basic
                            WHERE mem_no = #{paramMemNo}
                        )
                      )
                    )
                  )
                  OR
                  (view_type = 2 AND #{paramMemNo} LIKE '8%')
                )
                AND (
                  term_type = 0
                  OR
                  (term_type = 1 and now() between start_datetime and end_datetime)
                )
        ) TB
        ORDER BY RAND(10)
    </select>

    <select id="callMainPlanList" parameterType="String" resultType="P_MainRecommandVo">
        SELECT
            T1.mem_no AS memNo
            , T1.mem_nick AS nickNm
            , T1.mem_sex AS gender
            , T2.image_profile AS profileUrl
            , T3.room_no AS roomNo
            , T3.subject_type AS roomType
            , T3.title AS title
            , IFNULL(T3.count_entry, 0) AS listeners
            , IFNULL(T3.count_good, 0) AS likes
            , T2.image_background AS bannerUrl
        FROM tb_member_basic T1 INNER JOIN tb_member_profile T2 ON T1.mem_no = T2.mem_no
            INNER JOIN tb_broadcast_room T3 ON T1.mem_no = T3.mem_no AND T3.state &lt; 4
            INNER JOIN tb_broadcast_room_member T4 ON T3.room_no = T4.room_no AND T3.mem_no = T4.mem_no AND T4.auth = 3 AND T4.state = 0
        WHERE T1.mem_no IN (${value})
          AND T1.mem_state = 1
    </select>

    <select id="callMainStarList" parameterType="String" resultType="P_MainStarVo">
        SELECT
            T1.mem_no_star AS memNo
            , T2.mem_nick AS nickNm
            , T2.mem_sex AS gender
            , T3.image_profile AS profImgUrl
            , T4.room_no AS roomNo
            , T4.title AS title
            , T4.subject_type AS roomType
            , T4.code AS roomTypeNm
        FROM tb_member_fanstar T1 INNER JOIN tb_member_basic T2 ON T1.mem_no_star = T2.mem_no
            INNER JOIN tb_member_profile T3 ON T1.mem_no_star = T3.mem_no
            INNER JOIN (
                SELECT
                S1.room_no
                , S1.mem_no
                , S1.title
                , S1.subject_type
                , S3.code
                FROM tb_broadcast_room S1 INNER JOIN tb_broadcast_room_member S2 ON S1.mem_no = S2.mem_no AND S2.auth = 3 and S2.state = 0
                INNER JOIN tbl_code_define S3 ON S1.subject_type = S3.value AND S3.type = 'subject_type'
                WHERE S1.state &lt; 4
            ) T4 ON T1.mem_no_star = T4.mem_no
        WHERE T1.mem_no_fan = #{value}
        LIMIT 0, 10
    </select>

</mapper>