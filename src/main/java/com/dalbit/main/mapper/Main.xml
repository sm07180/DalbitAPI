<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.main.dao.MainDao" >

    <select id="callMainFanRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainFanRankingVo">
        call sp_ranking_fan(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainDjRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainDjRankingVo">
        call sp_ranking_dj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainMyDjList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainMyDjVo">
        call sp_broadcast_room_list_mydj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainRecommandList" parameterType="P_MainRecommandVo" resultType="P_MainRecommandVo">
        SELECT
            C.mem_no AS memNo
            , C.mem_nick AS nickNm
            , C.mem_sex AS gender
            , D.image_profile AS profileUrl
            , B.room_no AS roomNo
            , B.subject_type AS roomType
            , B.title AS title
            , A.entry AS listeners
            , (A.good+A.booster) AS likes
            , B.image_background AS bannerUrl
            , true AS isSpecial
        FROM tb_broadcast_room_live_list AS A
            INNER JOIN tb_broadcast_room AS B ON A.room_no = B.room_no
            INNER JOIN tb_member_basic AS C ON B.mem_no = C.mem_no AND B.state &lt; 4 AND C.mem_state = 1
            INNER JOIN tb_member_profile AS D ON B.mem_no = D.mem_no AND D.specialdj_badge = 1
        ORDER BY B.idx desc
        LIMIT 0, 10;
    </select>

    <select id="callMainRecommandLiveList" parameterType="P_MainRecommandVo" resultType="P_MainRecommandVo">
        SELECT
           B.mem_no AS memNo
           , (select mem_nick from tb_member_basic where mem_no = B.mem_no ) AS nickNm
           , (select mem_sex from tb_member_basic where mem_no = B.mem_no ) AS gender
           , (select image_profile from tb_member_profile where mem_no = B.mem_no ) AS profileUrl
           , B.room_no AS roomNo
           , B.subject_type AS roomType
           , B.title AS title
           , A.entry AS listeners
           , (A.good+A.booster) AS likes
           , B.image_background AS bannerUrl
           , false AS isSpecial
        FROM tb_broadcast_room_live_list A INNER JOIN tb_broadcast_room B ON A.room_no = B.room_no
        WHERE A.mem_no NOT IN (SELECT mem_no FROM tb_member_profile WHERE specialdj_badge = 1)
        ORDER BY A.total DESC
        LIMIT 0, 10;
    </select>

    <select id="selectBanner" parameterType="P_BannerVo" resultType="BannerVo">
        SELECT
            idx AS idx
            , thumb_img_url AS thumbsUrl
            , IF(#{paramDevice} = '3', pc_link_url, mobile_link_url) AS linkUrl
            , IF(is_pop = 1, 'popup', 'link') AS linkType
            , title
            , IF(#{paramDevice} = '3', pc_img_url, mobile_img_url) AS bannerUrl
            , popup_type
            , is_cookie
            , contents
        FROM rd_admin.tb_admin_banner
        WHERE is_view = 1
            AND position = #{paramPosition}
            AND (
              view_type = 0
              OR
              (
                (view_type = 1  AND (
                  sex = 0 OR sex = (
                        SELECT
                          (CASE
                            WHEN mem_sex = 'm' THEN 1
                            WHEN mem_sex = 'f' THEN 2
                            ELSE 3
                          END)
                        FROM tb_member_basic
                        WHERE mem_no = #{paramMemNo}
                    )
                  )
                )
              )
              OR
              (view_type = 2 AND #{paramMemNo} LIKE '8%')
            )
            AND (
              term_type = 0
              OR
              (term_type = 1 and now() between start_datetime and end_datetime)
            )
            AND platform LIKE #{paramPlatform}
    </select>

    <select id="selectBannerOld" parameterType="P_BannerVo" resultType="BannerVo">
        SELECT
            idx AS idx
            , thumb_img_url AS thumbsUrl
            , IF(#{paramDevice} = '3', pc_link_url, mobile_link_url) AS linkUrl
            , IF(is_pop = 1, 'popup', 'link') AS linkType
            , title
            , IF(#{paramDevice} = '3', pc_img_url, mobile_img_url) AS bannerUrl
        FROM rd_admin.tb_admin_banner
        WHERE is_view = 1
            AND position = #{paramPosition}
            AND (
              view_type = 0
              OR
              (
                (view_type = 1  AND (
                  sex = 0 OR sex = (
                        SELECT
                          (CASE
                            WHEN mem_sex = 'm' THEN 1
                            WHEN mem_sex = 'f' THEN 2
                            ELSE 3
                          END)
                        FROM tb_member_basic
                        WHERE mem_no = #{paramMemNo}
                    )
                  )
                )
              )
              OR
              (view_type = 2 AND #{paramMemNo} LIKE '8%')
            )
            AND (
              term_type = 0
              OR
              (term_type = 1 and now() between start_datetime and end_datetime)
            )
            AND platform LIKE #{paramPlatform}
    </select>

    <select id="callMainPlanList" parameterType="String" resultType="P_MainRecommandVo">
        SELECT
            T1.mem_no AS memNo
            , T1.mem_nick AS nickNm
            , T1.mem_sex AS gender
            , T2.image_profile AS profileUrl
            , T3.room_no AS roomNo
            , T3.subject_type AS roomType
            , T3.title AS title
            , IFNULL(T3.count_entry, 0) AS listeners
            , IFNULL(T3.count_good, 0) AS likes
            , T2.image_background AS bannerUrl
        FROM tb_member_basic T1
            INNER JOIN tb_member_profile T2 ON T1.mem_no = T2.mem_no
            INNER JOIN tb_broadcast_room T3 ON T1.mem_no = T3.mem_no AND T3.state &lt; 4
            INNER JOIN tb_broadcast_room_member T4 ON T3.room_no = T4.room_no AND T3.mem_no = T4.mem_no AND T4.auth = 3 AND T4.state = 0
        WHERE T1.mem_no IN (${value})
          AND T1.mem_state = 1
    </select>

    <select id="callMainStarList" parameterType="String" resultType="P_MainStarVo">
        SELECT
            DISTINCT
            T1.mem_no_star AS memNo
            , T2.mem_nick AS nickNm
            , T2.mem_sex AS gender
            , T3.image_profile AS profImgUrl
            , T4.room_no AS roomNo
            , T4.title AS title
            , T4.subject_type AS roomType
            , T4.code AS roomTypeNm
        FROM tb_member_fanstar T1 INNER JOIN tb_member_basic T2 ON T1.mem_no_star = T2.mem_no
            INNER JOIN tb_member_profile T3 ON T1.mem_no_star = T3.mem_no
            INNER JOIN (
                SELECT
                    S1.room_no
                    , S1.mem_no
                    , S1.title
                    , S1.subject_type
                    , S3.code
                    , S1.idx
                FROM tb_broadcast_room S1 INNER JOIN tb_broadcast_room_member S2 ON S1.mem_no = S2.mem_no AND S2.auth = 3 and S2.state = 0
                INNER JOIN tbl_code_define S3 ON S1.subject_type = S3.value AND S3.type = 'subject_type'
                WHERE S1.state &lt; 4
            ) T4 ON T1.mem_no_star = T4.mem_no
        WHERE T1.mem_no_fan = #{value}
        ORDER BY T4.idx desc
        LIMIT 0, 10
    </select>

</mapper>