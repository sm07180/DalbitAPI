<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.main.dao.MainDao" >

    <select id="callMainFanRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainFanRankingVo">
        call sp_ranking_fan(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainDjRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainDjRankingVo">
        call sp_ranking_dj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainMyDjList" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainMyDjVo">
        call sp_broadcast_room_list_mydj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainLevelRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="P_MainLevelRankingVo">
        call sp_ranking_level(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainRecommandList" parameterType="P_MainRecommandVo" resultType="P_MainRecommandVo">
        SELECT
            C.mem_no AS memNo
            , C.mem_nick AS nickNm
            , C.mem_sex AS gender
            , D.image_profile AS profileUrl
            , B.room_no AS roomNo
            , B.subject_type AS roomType
            , B.title AS title
            , A.entry AS listeners
            , (A.good+A.booster) AS likes
            , B.image_background AS bannerUrl
            , true AS isSpecial
            , D.admin_badge = 1 AS isAdmin
        FROM tb_broadcast_room_live_list AS A
            INNER JOIN tb_broadcast_room AS B ON A.room_no = B.room_no AND ${paramMemNo} NOT IN (SELECT black_mem_no FROM tb_member_broadcast_black WHERE mem_no = A.mem_no) AND ((A.mem_no = ${paramMemNo} AND A.hide = 1) OR A.hide = 0)
            INNER JOIN tb_member_basic AS C ON B.mem_no = C.mem_no AND B.state &lt; 4 AND C.mem_state = 1
            INNER JOIN tb_member_profile AS D ON B.mem_no = D.mem_no AND (D.specialdj_badge = 1 OR D.admin_badge = 1)
        ORDER BY D.admin_badge DESC, B.idx DESC
        LIMIT 0, 10;
    </select>

    <select id="callMainRecommandLiveList" parameterType="P_MainRecommandVo" resultType="P_MainRecommandVo">
        SELECT
           B.mem_no AS memNo
           , (select mem_nick from tb_member_basic where mem_no = B.mem_no ) AS nickNm
           , (select mem_sex from tb_member_basic where mem_no = B.mem_no ) AS gender
           , (select image_profile from tb_member_profile where mem_no = B.mem_no ) AS profileUrl
           , B.room_no AS roomNo
           , B.subject_type AS roomType
           , B.title AS title
           , A.entry AS listeners
           , (A.good+A.booster) AS likes
           , B.image_background AS bannerUrl
           , false AS isSpecial
           , false AS isAdmin
        FROM tb_broadcast_room_live_list A INNER JOIN tb_broadcast_room AS B ON A.room_no = B.room_no AND ${paramMemNo} NOT IN (SELECT black_mem_no FROM tb_member_broadcast_black WHERE mem_no = A.mem_no) AND ((A.mem_no = ${paramMemNo} AND A.hide = 1) OR A.hide = 0)
        WHERE A.mem_no NOT IN (SELECT mem_no FROM tb_member_profile WHERE (specialdj_badge = 1 OR admin_badge = 1))
        ORDER BY A.total DESC
        LIMIT 0, 10;
    </select>

    <select id="selectBanner" parameterType="P_BannerVo" resultType="BannerVo">
        SELECT
            idx AS idx
            , thumb_img_url AS thumbsUrl
            , IF(#{paramDevice} = '3', pc_link_url, mobile_link_url) AS linkUrl
            , IF(is_pop = 1, 'popup', 'link') AS linkType
            , title
            , IF(#{paramDevice} = '3', pc_img_url, mobile_img_url) AS bannerUrl
            , popup_type
            , is_cookie
            , contents
            , is_title_view
            , is_button_view
            , IF(is_button_view = 0, '확인', '상세로 이동') AS buttonNm
        FROM rd_admin.tb_admin_banner
        WHERE is_view = 1
            AND position = #{paramPosition}
            AND (
              view_type = 0
              OR
              (
                (view_type = 1  AND (
                  sex = 0 OR sex = (
                        SELECT
                          (CASE
                            WHEN mem_sex = 'm' THEN 1
                            WHEN mem_sex = 'f' THEN 2
                            ELSE 3
                          END)
                        FROM tb_member_basic
                        WHERE mem_no = #{paramMemNo}
                    )
                  )
                )
              )
              OR
              (view_type = 2 AND #{paramMemNo} LIKE '8%')
            )
            AND (
              term_type = 0
              OR
              (term_type = 1 and now() between start_datetime and end_datetime)
            )
            AND platform LIKE #{paramPlatform}
        ORDER BY `order` asc, idx DESC
    </select>

    <select id="callMainStarList" parameterType="String" resultType="P_MainStarVo">
        SELECT
            DISTINCT
            T1.mem_no_star AS memNo
            , T2.mem_nick AS nickNm
            , T2.mem_sex AS gender
            , T3.image_profile AS profImgUrl
            , T4.room_no AS roomNo
            , T4.title AS title
            , T4.subject_type AS roomType
            , T4.code AS roomTypeNm
        FROM tb_member_fanstar T1 INNER JOIN tb_member_basic T2 ON T1.mem_no_star = T2.mem_no
            INNER JOIN tb_member_profile T3 ON T1.mem_no_star = T3.mem_no
            LEFT OUTER JOIN (
                SELECT
                    S1.room_no
                    , S1.mem_no
                    , S4.title
                    , S4.subject_type
                    , S3.code
                    , S4.idx
                FROM tb_broadcast_room_live_list S1 INNER JOIN tb_broadcast_room AS S4 ON S1.room_no = S4.room_no
                  INNER JOIN tb_broadcast_room_member S2 ON S1.mem_no = S2.mem_no AND S2.auth = 3 and S2.state = 0
                  INNER JOIN tbl_code_define S3 ON S4.subject_type = S3.value AND S3.type = 'subject_type'
                WHERE S4.state &lt; 4
                  AND ${value} NOT IN (SELECT black_mem_no FROM tb_member_broadcast_black WHERE mem_no = S1.mem_no)
                  AND ((S1.mem_no = ${value} AND S1.hide = 1) OR S1.hide = 0)
            ) T4 ON T1.mem_no_star = T4.mem_no
        WHERE T1.mem_no_fan = #{value}
        ORDER BY IFNULL(T4.idx, 0) DESC, T2.mem_nick ASC
        LIMIT 0, 10
    </select>

</mapper>